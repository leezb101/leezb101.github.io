<!DOCTYPE html>
<html>
<head>
  <link rel="canonical" href="{{ site.url }}{{ page.url }}">
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>测试openUrl</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script>
    var host = 'moxiaobai.cc'
    if ((host == window.location.host) && (window.location.protocol != "https:")) {
      window.location.protocol = "https"
    }
  </script>
</head>
<body>
  <div id='display-tag'>这里需要获取经纬度</div>
  <button type="button">点我获取</button>
  <button type="button" class="jump">点我跳转</button>
</body>
<script>
  var display = document.querySelector('div#display-tag')
  var btn = document.querySelector('button')
  var jumpBtn = document.querySelector('button.jump')

  function get(url) {
    return new Promise(function (resolve, reject) {
      var req = new XMLHttpRequest()
      req.open('GET', url)

      req.onload = function () {
        if (req.status == 200) {
          resolve(req.response)
        } else {
          reject(Error(req.statusText))
        }
      }
      req.onerror = function () {
        reject(Error(req.statusText))
      }

      req.send()
    })
  }
  
  function post (url, params) {
    return new Promise(function (resolve, reject) {
      var req = new XMLHttpRequest()
      req.open('POST', url, true)

      req.onload = function () {
        if (req.status == 200) {
          resolve(req.response)
        } else {
          reject(Error(req.statusText))
        }        
      }

      req.onerror = function () {
        reject(Error(req.statusText))
      }

      req.send(JSON.stringify(params))
    })
  }


  var action = function getLocation () {
    // 此处需要获取当前用户信息
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition((position) => {
        var lat = position.coords.latitude
        var long = position.coords.longitude
        lat = lat.toFixed(6)
        long = long.toFixed(6)
        
        const key = 'ee525f82e554b594dc67d880f2ad0676'
        var param = {}
        param.key = key
        param.location = `${lat},${long}`

        const geoUrl = 'https://restapi.amap.com/v3/geocode/regeo'
        var finalUrl = `${geoUrl}?key=${key}&location=${param.location}`
        console.log('这里需要调用高德地图API获取地理信息逆编码...')
        
        get(finalUrl).then((response) => {
          console.log(response)
          var result = JSON.parse(response)
          if (result.status === '1') {
            var city = result.regeocode.addressComponent.city[0]
            var building = result.regeocode.addressComponent.building.name[0]
            alert(`当前您所在的位置为——\n${city}, ${building}\n所在地理坐标为——\n${param.lat}, ${param.long}`)
          }
        }, (error) => {
          console.log('获取地理信息逆编码失败...')
          console.log(error)
        })

      }, () => {
        display.innerHTML = '获取地理位置失败'
      })
    }
  }

  btn.onclick = action

</script>
</html>